---
typora-copy-images-to: SpringCloudPictures
---

# 什么是服务注册中心

所谓服务注册中心就是在整个的微服务架构中单独提出一个服务，这个服务==不完成系统的任何的业务功能==，仅仅用来完成对整个微服务系统的`服务注册`和`服务发现`，以及对`服务健康状态`的`监控和管理`功能。

![服务注册中心](SpringCloudPictures/服务注册中心.png)

- 可以==存储所有的微服务的信息==，如微服务的==名称、IP、端口==等；
- 可以在进行服务调用时，通过服务发现，==查询可用的微服务列表==，及网络地址，进行服务调用。
- 可以对所有的微服务进行==心跳检测==，如发现某实例长时间无法访问，就会从服务注册表移除该实例。

Spring Cloud 支持的多种注册中心 Eureka（Netflix）、Consul（Go）、Zookeeper（Java，没有提供 UI 管理界面）、以及阿里巴巴推出的 Nacos。这些注册中心在本质上都是用来==管理服务的注册和发现==以及==服务状态的检查==。

# Eureka Server（服务注册中心）

## 创建项目并引入依赖

- 创建 SpringBoot 项目并引入 Eureka Server 依赖：

在`SpringCloudParent`（[创建父项目](微服务介绍.md)）下创建`Modules` :arrow_right: 选择 Maven，不要选择`Create from archetype`，
地址：D:\Learning\SpringCloud\SpringCloudCode\SpringCloudDemo\SpringCloudDemoParent\EurekaServer。

- 在`pom.xml`中引入依赖（`spring-cloud-starter-netflix-eureka-server`）

```xml
<dependencies>
    <!--引入SpringBootWeb-->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <!--引入Eureka Server-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
    </dependency>
</dependencies>
```

## 编写配置

`application.properties`

```properties
# 执行服务的端口
server.port=8761
# 指定服务名称，唯一标识
spring.application.name=EurekaServer
# 指定服务注册中心的地址 
# http://localhost:8761 在注册中心页面不会显示【自己向自己注册】，但后台仍会报错
eureka.client.service-url.defaultZone=http://localhost:8761/eureka
```

## 入口类

入口类加入注解：`@EnableEurekaServer`：

```java
package com.example;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;

@SpringBootApplication
@EnableEurekaServer
public class EurekaServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaServerApplication.class, args);
    }
}
```

## 访问注册中心

[http://localhost:8761](http://localhost:8761)

![服务注册中心页面](SpringCloudPictures/服务注册中心页面.png)

## 后台报错

![控制台报错](SpringCloudPictures/控制台报错.png)

出现上述问题原因：既当 server 又当 client。
	

Eureka 组件包含 Eureka Server 和 Eureka Client。Server 是一个==服务注册中心==，用来接受客户端的注册。Server启动时，会将自己作为一个服务中心启动；与此同时，Client的特性会让当前启动的服务，把自己作为 Eureka 的客户端，进行服务中心的注册，默认是启动时立即注册。==当项目启动时，服务注册中心还没有创建好，所以找不到服务的客户端组件，就直接报错了==。当启动成功服务注册中心创建好了，日后 Client 也能进行注册，就不再报错啦！

如果需要其作为一个纯 Eureka Server，需要==关闭 Eureka 自己注册自己==。

## 关闭 Eureka 自己注册自己

```properties
# 执行服务的端口
server.port=8761
# 指定服务名称，唯一标识
spring.application.name=EurekaServer
# 指定服务注册中心的地址
eureka.client.service-url.defaultZone=http://localhost:8761/eureka

# 不再将自己同时作为客户端进行注册
eureka.client.register-with-eureka=false
# 关闭作为客户端时从Eureka Server获取服务信息。让当前服务仅为服务注册中心
eureka.client.fetch-registry=false
```

# 开发 Eureka Client

Eureka Client 就是日后基于业务差分出来的一个个`微服务`。

## 开发过程

### 创建项目并引入依赖

继承[父项目](微服务介绍.md)：在`SpringCloudParent`下创建`Modules`$$\longrightarrow$$​选择 Maven，不要选择`Create from archetype`，
地址：D:\Learning\SpringCloud\SpringCloudCode\SpringCloudDemo\SpringCloudDemoParent\EurekaClient。

在`pom.xml`中引入依赖（`spring-cloud-starter-netflix-eureka-client`）：

```xml
<dependencies>
    <!--引入SpringBootWeb-->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <!--引入Eureka Client-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
    </dependency>
</dependencies>
```

### 配置文件

`application.properties`

```properties
# 执行服务的端口
server.port=8888
# 指定服务名称，唯一标识
spring.application.name=EurekaClient
# 指定服务注册中心的地址
eureka.client.service-url.defaultZone=http://localhost:8761/eureka
```

### Client 入口类加入注解

入口类加入注解`@EnableEurekaClient`

```java
package com.example;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;

@SpringBootApplication
@EnableEurekaClient
public class EurekaClientApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaClientApplication.class, args);
    }
}
```

### 启动测试

启动之前 8761 的服务注册中心，再启动 Eureka Client 服务，查看 Eureka Server 的服务注册情况：

服务注册中心控制台输出：

```markdown
Registered instance EUREKACLIENT/localhost:EurekaClient:8888 with status UP (replication=false)
```

Eureka Client 后台输出：

```markdown
Getting all instance registry info from the eureka server
DiscoveryClient_EUREKACLIENT/localhost:EurekaClient:8888 - registration status: 204
```

![Client注册到Server](SpringCloudPictures/Client注册到Server.png)

## 使用 Eureka 编写服务提供者

参考资料：[使用 Eureka 编写服务提供者 (biancheng.net)](http://c.biancheng.net/view/5323.html)

注册中心已经创建并且启动好了，接下来实现将一个服务提供者 `EurekaServiceProvider` 注册到 Eureka 中，并==提供一个接口==给其他服务调用。

### 创建项目、添加依赖

继承[父项目](微服务介绍.md)：在`SpringCloudParent`下创建`Modules`$$\longrightarrow$$选择 Maven，不要选择`Create from archetype`，
地址：D:\Learning\SpringCloud\SpringCloudCode\SpringCloudDemo\SpringCloudDemoParent\EurekaServiceProvider

```xml
<dependencies>
    <!--引入SpringBootWeb-->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <!--引入Eureka Client-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
    </dependency>
</dependencies>
```

### 配置文件

`application.properties`

```properties
# 执行服务的端口
server.port=8889
# 指定服务名称，唯一标识
spring.application.name=EurekaServiceProvider
# 指定服务注册中心的地址
eureka.client.service-url.defaultZone=http://localhost:8761/eureka
# 采用IP注册
eureka.instance.prefer-ip-address=true
# 定义实例ID格式
eureka.instance.instance-id=${spring.application.name}:${spring.cloud.client.ip-address}:${server.port}
```

### Client 入口类加入注解

入口类加入注解`@EnableEurekaClient`

```java
package com.example;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;

/**
 * @author chenzufeng
 * @date 2021/7/30
 * @usage EurekaServiceProviderApplication 服务提供者
 */
@EnableEurekaClient
@SpringBootApplication
public class EurekaServiceProviderApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaServiceProviderApplication.class, args);
    }
}
```

### 测试

先启动服务注册中心，然后启动`EurekaServiceProviderApplication`，其后台显示：

```markdown
DiscoveryClient_EUREKASERVICEPROVIDER/EurekaServiceProvider:192.168.43.1:8889 - registration status: 204
```

服务注册中心：

```markdown
Registered instance EUREKASERVICEPROVIDER/EurekaServiceProvider:192.168.43.1:8889 with status UP (replication=false)
```

![服务提供者_服务注册中心](SpringCloudPictures/服务提供者_服务注册中心.png)

### 编写服务接口

```java
package com.example.controller;

import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

/**
 * @author chenzufeng
 * @date 2021/7/30
 * @usage ServiceProviderController 服务接口
 */
@RestController
public class ServiceProviderController {
    @RequestMapping("Service")
    public String hello() {
        return "服务提供者为您服务。。。";
    }
}
```

启动服务，访问：[localhost:8889/Service](http://localhost:8889/Service)，页面输出：

```markdown
服务提供者为您服务。。。
```



## 使用 Eureka 编写服务消费者

参考资料：[使用 Eureka 编写服务消费者 (biancheng.net)](http://c.biancheng.net/view/5324.html)

### 创建项目、添加依赖

继承[父项目](微服务介绍.md)：在`SpringCloudParent`下创建`Modules`$$\longrightarrow$$选择 Maven，不要选择`Create from archetype`，
地址：D:\Learning\SpringCloud\SpringCloudCode\SpringCloudDemo\SpringCloudDemoParent\EurekaServiceConsumer

```xml
<dependencies>
    <!--引入SpringBootWeb-->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <!--引入Eureka Client-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
    </dependency>
</dependencies>
```

### 配置文件

`application.properties`

```properties
# 执行服务的端口
server.port=8890
# 指定服务名称，唯一标识
spring.application.name=EurekaServiceConsumer
# 指定服务注册中心的地址
eureka.client.service-url.defaultZone=http://localhost:8761/eureka
# 采用IP注册
eureka.instance.prefer-ip-address=true
# 定义实例ID格式
eureka.instance.instance-id=${spring.application.name}:${spring.cloud.client.ip-address}:${server.port}
```

### Client 入口类加入注解

入口类加入注解`@EnableEurekaClient`

```java
package com.example;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;

/**
 * @author chenzufeng
 * @date 2021/7/30
 * @usage EurekaServiceConsumerApplication 服务消费者
 */
@SpringBootApplication
@EnableEurekaClient
public class EurekaServiceConsumerApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaServiceConsumerApplication.class, args);
    }
}
```

### 配置类中的 RestTemplate

`RestTemplate` 是 Spring 提供的用于==访问 Rest 服务==的客户端，RestTemplate 提供了多种便捷访问远程 HTTP 服务的方法，能够大大提高客户端的编写效率。==通过配置 RestTemplate 来调用接口==：

```java
package com.example.config;

import org.springframework.cloud.client.loadbalancer.LoadBalanced;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.client.RestTemplate;

/**
 * @author chenzufeng
 * @date 2021/7/30
 * @usage BeanConfiguration 通过配置 RestTemplate 来调用接口
 * @LoadBalanced 会自动构造 LoadBalancerClient 接口的实现类并注册到 Spring 容器中
 */
@Configuration
public class BeanConfiguration {
    @Bean
    @LoadBalanced
    public RestTemplate getRestTemplate() {
        return new RestTemplate();
    }
}
```

### 编写控制器

```java
package com.example.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

/**
 * @author chenzufeng
 * @date 2021/7/30
 * @usage ServiceConsumerController 服务消费者控制器
 */
@RestController
public class ServiceConsumerController {
    @Autowired
    private RestTemplate getRestTemplate;

    @RequestMapping("/CallService")
    public String callHello() {
        return getRestTemplate.getForObject("http://EurekaServiceProvider/Service",String.class);
    }
}
```

### 测试

启动服务注册中心、服务提供者和服务消费者，然后输入测试地址：[localhost:8890/CallService](http://localhost:8890/CallService)，输出：`服务提供者为您服务。。。`。


# 搭建 Eureka 注册中心集群

由于所有服务都会注册到注册中心去，==服务之间的调用都是通过从注册中心获取的服务列表来调用，注册中心一旦宕机，所有服务调用都会出现问题==。所以需要多个注册中心组成集群，来提供服务。

## 搭建集群

方法一：分别创建三个 Eureka Server 项目：`8761`、`8762`、`8763`。

方法二：设置`VM options`。

选择`Edit Configuration...`，复制`EurekaServerApplication`（`Copy Configuration`），并进行修改：

- `Name: EurekaServerApplication8761 ` $$\rightarrow$$​​​ `VM options: -Dserver.port=8761`

    - 修改`application.properties`

    ```properties
    # 执行服务的端口
    server.port=8761
    # 指定服务名称，唯一标识
    spring.application.name=EurekaServer
    # 指定服务注册中心的地址
    eureka.client.service-url.defaultZone=http://localhost:8762/eureka, http://localhost:8763/eureka
    ```

    - 立即启动：`run EurekaServerApplication8761`！
    - 控制台输出：

    ```markdown
    Adding new peer nodes [http://localhost:8763/eureka/, http://localhost:8762/eureka/]
    ```

    

- `Name: EurekaServerApplication8762 ` $$\rightarrow$$​​ `VM options: -Dserver.port=8762`

    - 修改`application.properties`

    ```properties
    # 执行服务的端口
    server.port=8762
    # 指定服务名称，唯一标识
    spring.application.name=EurekaServer
    # 指定服务注册中心的地址
    eureka.client.service-url.defaultZone=http://localhost:8761/eureka, http://localhost:8763/eureka
    ```

    - 立即启动：`run EurekaServerApplication8762`！
    - 控制台输出：

    ```markdown
    Adding new peer nodes [http://localhost:8763/eureka/, http://localhost:8761/eureka/]
    ```

    

- `Name: EurekaServerApplication8763 ` $$\rightarrow$$​​ `VM options: -Dserver.port=8763`

    - 修改`application.properties`

    ```properties
    # 执行服务的端口
    server.port=8763
    # 指定服务名称，唯一标识
    spring.application.name=EurekaServer
    # 指定服务注册中心的地址
    eureka.client.service-url.defaultZone=http://localhost:8761/eureka, http://localhost:8762/eureka
    ```

    - 立即启动：`run EurekaServerApplication8763`！
    - 控制台输出：

    ```markdown
    Adding new peer nodes [http://localhost:8761/eureka/, http://localhost:8762/eureka/]
    ```

